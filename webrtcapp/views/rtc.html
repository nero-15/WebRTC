<!DOCTYPE html>
<html lang="ja">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>WebRTC RTCDataChannel</title>
</head>
<body>
	<p>RTCDataChannel</p>
	<div>
		<button id="connectButton">
			Connect
		</button>
		<button id="disconnectButton" disabled>
			Disconnect
		</button>
	</div>

	<div class="messagebox">
		<label for="message">
			Enter a message:
			<input type="text" name="message" id="message" placeholder="Message text" disabled>
		</label>
		<button id="sendButton" disabled>
			Send
		</button>
	</div>
	<div class="messagebox" id="receivebox">
		<p>Messages received:</p>
	</div>

<script>
(function() {

	var connectButton = null;
	var disconnectButton = null;
	var sendButton = null;
	var messageInputBox = null;
	var receiveBox = null;

	var localConnection = null;
	var remoteConnection = null;

	function startup() {
		connectButton = document.getElementById('connectButton');
		disconnectButton = document.getElementById('disconnectButton');
		sendButton = document.getElementById('sendButton');
		messageInputBox = document.getElementById('message');
		receiveBox = document.getElementById('receivebox');

		connectButton.addEventListener('click', connectPeers, false);
		//disconnectButton.addEventListener('click', disconnectPeers, false);
		//sendButton.addEventListener('click', sendMessage, false);
	}

	function connectPeers() {
		localConnection = new RTCPeerConnection();
		sendChannel = localConnection.createDataChannel("sendChannel");
		sendChannel.onopen = handleSendChannelStatusChange;
		sendChannel.onclose = handleSendChannelStatusChange;

		remoteConnection = new RTCPeerConnection();
		remoteConnection.ondatachannel = receiveChannelCallback;

		localConnection.onicecandidate = e => !e.candidate
			|| remoteConnection.addIceCandidate(e.candidate)
			.catch(handleAddCandidateError);

		remoteConnection.onicecandidate = e => !e.candidate
			|| localConnection.addIceCandidate(e.candidate)
			.catch(handleAddCandidateError);

		localConnection.createOffer()
			.then(offer => localConnection.setLocalDescription(offer))
			.then(() => remoteConnection.setRemoteDescription(localConnection.localDescription))
			.then(() => remoteConnection.createAnswer())
			.then(answer => remoteConnection.setLocalDescription(answer))
			.then(() => localConnection.setRemoteDescription(remoteConnection.localDescription))
			.catch(handleCreateDescriptionError);
	}

	function handleCreateDescriptionError(error) {
		console.log("Unable to create an offer: " + error.toString());
	}



	window.addEventListener('load', startup, false);
 })();
</script>
</body>
</html>
